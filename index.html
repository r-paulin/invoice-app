<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invio — Free online invoice generator</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <script defer src="https://unpkg.com/alpinejs@3.13.3/dist/cdn.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js" crossorigin="anonymous"></script>
  <style>
    .invio-logo { font-weight: 700; color: var(--bs-success) !important; }
    .nav-tabs .nav-link { color: #6c757d; font-weight: 500; border: none; border-bottom: 2px solid transparent; padding: 0.75rem 1rem; }
    .nav-tabs .nav-link.active { color: var(--bs-success); background: transparent; border-bottom-color: var(--bs-success); }
    .invio-card-empty { cursor: pointer; transition: border-color .15s, box-shadow .15s; }
    .invio-card-empty:hover { border-color: var(--bs-success); box-shadow: 0 0 0 2px rgba(25, 135, 84, 0.15); }
    .table-items .form-control, .table-items .form-select { font-size: 0.875rem; padding: 0.35rem 0.5rem; }
    .totals-block { max-width: 220px; margin-left: auto; }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4" x-data="invioApp()" x-init="init()">
    <!-- Header: logo + language -->
    <header class="d-flex justify-content-between align-items-start mb-3">
      <div>
        <a class="invio-logo text-decoration-none fs-5" href="#">invio</a>
      </div>
      <div class="dropdown">
        <button class="btn btn-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">English</button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li><a class="dropdown-item" href="#">English</a></li>
        </ul>
      </div>
    </header>

    <h1 class="h3 fw-bold mb-1">Free online invoice generator</h1>
    <p class="text-muted mb-4">Generate downloadable PDF invoices and compliant e-invoices directly in your browser.</p>

    <!-- Tabs -->
    <ul class="nav nav-tabs mb-4" role="tablist">
      <li class="nav-item">
        <button type="button" class="nav-link" :class="{ active: activeTab === 'invoice' }" @click="activeTab = 'invoice'">Invoice data</button>
      </li>
      <li class="nav-item">
        <button type="button" class="nav-link" :class="{ active: activeTab === 'settings' }" @click="activeTab = 'settings'">Settings</button>
      </li>
    </ul>

    <!-- Invoice data tab -->
    <div x-show="activeTab === 'invoice'" x-cloak>
      <!-- Basic details -->
      <section class="mb-4">
        <h2 class="h6 fw-bold mb-3">Basic details</h2>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Invoice number *</label>
            <input type="text" class="form-control" :class="{ 'is-invalid': errors.header?.invoiceNumber }" x-model="draft.header.invoiceNumber" placeholder="Enter invoice number">
            <div class="invalid-feedback" x-show="errors.header?.invoiceNumber" x-text="errors.header?.invoiceNumber"></div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Payment reference *</label>
            <input type="text" class="form-control" x-model="draft.header.buyerReference" placeholder="Enter payment reference">
          </div>
          <div class="col-md-6">
            <label class="form-label">Issue date *</label>
            <div class="input-group">
              <input type="date" class="form-control" :class="{ 'is-invalid': errors.header?.issueDate }" x-model="draft.header.issueDate">
              <span class="input-group-text"><i class="bi bi-calendar3"></i></span>
            </div>
            <div class="invalid-feedback d-block" x-show="errors.header?.issueDate" x-text="errors.header?.issueDate"></div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Due date *</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-calendar3"></i></span>
              <input type="date" class="form-control" x-model="draft.header.dueDate">
            </div>
          </div>
        </div>
      </section>

      <!-- Seller card (empty state → opens modal) -->
      <section class="mb-4">
        <h2 class="h6 fw-bold mb-3">Seller</h2>
        <div class="card invio-card-empty border" @click="modalOpen = 'seller'">
          <div class="card-body text-center py-5">
            <i class="bi bi-briefcase text-muted fs-1 mb-2"></i>
            <p class="text-muted mb-3" x-text="draft.seller.name ? draft.seller.name : 'Enter your business details'"></p>
            <button type="button" class="btn btn-success" @click.stop="modalOpen = 'seller'">+ Add details</button>
          </div>
        </div>
      </section>

      <!-- Buyer card (empty state → opens modal) -->
      <section class="mb-4">
        <h2 class="h6 fw-bold mb-3">Buyer</h2>
        <div class="card invio-card-empty border" @click="modalOpen = 'buyer'">
          <div class="card-body text-center py-5">
            <i class="bi bi-briefcase text-muted fs-1 mb-2"></i>
            <p class="text-muted mb-3" x-text="draft.buyer.name ? draft.buyer.name : 'Enter your customer details'"></p>
            <button type="button" class="btn btn-success" @click.stop="modalOpen = 'buyer'">+ Add details</button>
          </div>
        </div>
      </section>

      <!-- Items -->
      <section class="mb-4">
        <h2 class="h6 fw-bold mb-3">Items</h2>
        <div class="small text-muted mb-2">
          <a href="#" class="text-decoration-none text-muted me-3">+ Add fields</a>
          <a href="#" class="text-decoration-none text-muted me-3">+ Tax rate</a>
          <a href="#" class="text-decoration-none text-muted me-3">+ Discount</a>
          <a href="#" class="text-decoration-none text-muted me-3">+ ID code</a>
          <a href="#" class="text-decoration-none text-muted">+ Note</a>
        </div>
        <div class="table-responsive border rounded">
          <table class="table table-items table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>Service / Product</th>
                <th>Quantity</th>
                <th>Unit price</th>
                <th>Total</th>
                <th style="width: 40px;"></th>
              </tr>
            </thead>
            <tbody>
              <template x-for="(line, i) in draft.lines" :key="line.id">
                <tr>
                  <td>
                    <input type="text" class="form-control form-control-sm" :class="{ 'is-invalid': errors.lines && errors.lines[i] }" x-model="draft.lines[i].itemName" placeholder="Enter name">
                    <div class="invalid-feedback" x-show="errors.lines && errors.lines[i]" x-text="errors.lines[i]"></div>
                  </td>
                  <td>
                    <div class="input-group input-group-sm">
                      <input type="number" step="any" min="0.001" class="form-control" style="max-width: 70px;" x-model.number="draft.lines[i].quantity">
                      <select class="form-select form-select-sm" style="max-width: 85px;" x-model="draft.lines[i].unitCode">
                        <template x-for="opt in unitCodeOptions" :key="opt.value">
                          <option :value="opt.value" x-text="opt.label"></option>
                        </template>
                      </select>
                    </div>
                  </td>
                  <td>
                    <input type="number" step="0.01" min="0" class="form-control form-control-sm" style="max-width: 100px;" x-model.number="draft.lines[i].netPrice">
                    <span class="small text-muted" x-text="draft.header.currencyCode || 'EUR'"></span>
                  </td>
                  <td class="align-middle" x-text="(lineNet(draft.lines[i]) || 0).toFixed(2) + ' ' + (draft.header.currencyCode || 'EUR')"></td>
                  <td class="align-middle">
                    <button type="button" class="btn btn-outline-danger btn-sm py-0 px-1" x-show="draft.lines.length > 1" @click="removeLine(i)">−</button>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
        <button type="button" class="btn btn-success mt-2" @click="addLine()">+ Add item</button>

        <div class="totals-block mt-3">
          <div class="d-flex justify-content-between small"><span>Subtotal</span><span x-text="(totals && totals.lineNetSum != null ? totals.lineNetSum.toFixed(2) : '0.00') + ' ' + (draft.header.currencyCode || 'EUR')"></span></div>
          <div class="d-flex justify-content-between fw-bold"><span>Total</span><span x-text="(totals && totals.payable != null ? totals.payable.toFixed(2) : '0.00') + ' ' + (draft.header.currencyCode || 'EUR')"></span></div>
        </div>
      </section>

      <!-- Invoice ready CTA -->
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 py-3 border-top">
        <span class="text-muted">Invoice ready?</span>
        <button type="button" class="btn btn-success" @click="exportAll()">Create invoice</button>
      </div>
      <p class="text-danger small" x-show="summaryError" x-text="summaryError"></p>
    </div>

    <!-- Settings tab -->
    <div x-show="activeTab === 'settings'" x-cloak>
      <h2 class="h6 fw-bold mb-3">Settings</h2>
      <div class="row g-3">
        <div class="col-md-4">
          <div class="card invio-card-empty border h-100" @click="modalOpen = 'seller'">
            <div class="card-body text-center py-4">
              <i class="bi bi-briefcase text-muted fs-4 mb-2"></i>
              <h3 class="h6 fw-bold">Seller</h3>
              <p class="small text-muted mb-0" x-text="draft.seller.name || 'Add details'"></p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card invio-card-empty border h-100" @click="modalOpen = 'buyer'">
            <div class="card-body text-center py-4">
              <i class="bi bi-briefcase text-muted fs-4 mb-2"></i>
              <h3 class="h6 fw-bold">Buyer</h3>
              <p class="small text-muted mb-0" x-text="draft.buyer.name || 'Add details'"></p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card invio-card-empty border h-100" @click="modalOpen = 'payment'">
            <div class="card-body text-center py-4">
              <i class="bi bi-credit-card text-muted fs-4 mb-2"></i>
              <h3 class="h6 fw-bold">Payment</h3>
              <p class="small text-muted mb-0" x-text="draft.payment.accountId || draft.payment.bankName || 'Add details'"></p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modals: Bootstrap-styled, Alpine-controlled -->
    <template x-teleport="body">
      <div class="modal fade" :class="{ show: modalOpen === 'seller' }" :style="modalOpen === 'seller' ? 'display: block' : ''" tabindex="-1" x-show="modalOpen === 'seller'" x-transition>
        <div class="modal-dialog modal-dialog-scrollable">
          <div class="modal-content" @click.stop>
            <div class="modal-header">
              <h5 class="modal-title">Seller</h5>
              <button type="button" class="btn-close" @click="modalOpen = null"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3"><label class="form-label">Name *</label><input type="text" class="form-control" x-model="draft.seller.name" placeholder="Company or person name"></div>
              <div class="mb-3"><label class="form-label">Legal / Trade name</label><input type="text" class="form-control" x-model="draft.seller.tradeName"></div>
              <div class="mb-3"><label class="form-label">Registration number</label><input type="text" class="form-control" x-model="draft.seller.legalRegistrationId"></div>
              <div class="mb-3"><label class="form-label">VAT number</label><input type="text" class="form-control" x-model="draft.seller.vatId"></div>
              <div class="mb-3"><label class="form-label">E-mail</label><input type="email" class="form-control" :class="{ 'is-invalid': errors.seller?.email }" x-model="draft.seller.contact.email"><div class="invalid-feedback" x-show="errors.seller?.email" x-text="errors.seller?.email"></div></div>
              <div class="mb-3"><label class="form-label">Phone</label><input type="text" class="form-control" x-model="draft.seller.contact.phone"></div>
              <div class="mb-3"><label class="form-label">Address</label><input type="text" class="form-control" x-model="draft.seller.address.line1"></div>
              <div class="row g-2"><div class="col-6"><label class="form-label">City</label><input type="text" class="form-control" x-model="draft.seller.address.city"></div><div class="col-6"><label class="form-label">Postal code</label><input type="text" class="form-control" x-model="draft.seller.address.postalCode"></div></div>
              <div class="mb-3"><label class="form-label">Country</label><select class="form-select" x-model="draft.seller.address.countryCode"><option value="">—</option><template x-for="opt in countryOptions" :key="opt.value"><option :value="opt.value" x-text="opt.label"></option></template></select></div>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-success" @click="modalOpen = null">Done</button></div>
          </div>
        </div>
        <div class="modal-backdrop fade" :class="{ show: modalOpen === 'seller' }" @click="modalOpen = null"></div>
      </div>

      <div class="modal fade" :class="{ show: modalOpen === 'buyer' }" :style="modalOpen === 'buyer' ? 'display: block' : ''" tabindex="-1" x-show="modalOpen === 'buyer'" x-transition>
        <div class="modal-dialog modal-dialog-scrollable">
          <div class="modal-content" @click.stop>
            <div class="modal-header"><h5 class="modal-title">Buyer</h5><button type="button" class="btn-close" @click="modalOpen = null"></button></div>
            <div class="modal-body">
              <div class="mb-3"><label class="form-label">Name *</label><input type="text" class="form-control" x-model="draft.buyer.name" placeholder="Company or person name"></div>
              <div class="mb-3"><label class="form-label">Legal / Trade name</label><input type="text" class="form-control" x-model="draft.buyer.tradeName"></div>
              <div class="mb-3"><label class="form-label">Registration number</label><input type="text" class="form-control" x-model="draft.buyer.legalRegistrationId"></div>
              <div class="mb-3"><label class="form-label">VAT number</label><input type="text" class="form-control" x-model="draft.buyer.vatId"></div>
              <div class="mb-3"><label class="form-label">E-mail</label><input type="email" class="form-control" :class="{ 'is-invalid': errors.buyer?.email }" x-model="draft.buyer.contact.email"><div class="invalid-feedback" x-show="errors.buyer?.email" x-text="errors.buyer?.email"></div></div>
              <div class="mb-3"><label class="form-label">Phone</label><input type="text" class="form-control" x-model="draft.buyer.contact.phone"></div>
              <div class="mb-3"><label class="form-label">Address</label><input type="text" class="form-control" x-model="draft.buyer.address.line1"></div>
              <div class="row g-2"><div class="col-6"><label class="form-label">City</label><input type="text" class="form-control" x-model="draft.buyer.address.city"></div><div class="col-6"><label class="form-label">Postal code</label><input type="text" class="form-control" x-model="draft.buyer.address.postalCode"></div></div>
              <div class="mb-3"><label class="form-label">Country</label><select class="form-select" x-model="draft.buyer.address.countryCode"><option value="">—</option><template x-for="opt in countryOptions" :key="opt.value"><option :value="opt.value" x-text="opt.label"></option></template></select></div>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-success" @click="modalOpen = null">Done</button></div>
          </div>
        </div>
        <div class="modal-backdrop fade" :class="{ show: modalOpen === 'buyer' }" @click="modalOpen = null"></div>
      </div>

      <div class="modal fade" :class="{ show: modalOpen === 'payment' }" :style="modalOpen === 'payment' ? 'display: block' : ''" tabindex="-1" x-show="modalOpen === 'payment'" x-transition>
        <div class="modal-dialog">
          <div class="modal-content" @click.stop>
            <div class="modal-header"><h5 class="modal-title">Payment</h5><button type="button" class="btn-close" @click="modalOpen = null"></button></div>
            <div class="modal-body">
              <div class="mb-3"><label class="form-label">Payment type</label><select class="form-select" x-model="draft.payment.meansTypeCode"><option value="30">Credit Transfer</option><option value="48">Bank transfer</option></select></div>
              <div class="mb-3"><label class="form-label">Bank name</label><input type="text" class="form-control" x-model="draft.payment.bankName"></div>
              <div class="mb-3"><label class="form-label">SWIFT/BIC</label><input type="text" class="form-control" x-model="draft.payment.bic"></div>
              <div class="mb-3"><label class="form-label">IBAN</label><input type="text" class="form-control" :class="{ 'is-invalid': errors.payment?.iban }" x-model="draft.payment.accountId"><div class="invalid-feedback" x-show="errors.payment?.iban" x-text="errors.payment?.iban"></div></div>
              <div class="mb-3"><label class="form-label">Additional notes</label><textarea class="form-control" x-model="draft.payment.notes" rows="2"></textarea></div>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-success" @click="modalOpen = null">Done</button></div>
          </div>
        </div>
        <div class="modal-backdrop fade" :class="{ show: modalOpen === 'payment' }" @click="modalOpen = null"></div>
      </div>
    </template>
  </div>

  <!-- Footer -->
  <footer class="container py-4 mt-4 border-top text-center text-muted small">
    <a class="invio-logo text-decoration-none" href="#">invio</a>
    <span class="mx-2">·</span>
    <a href="#" class="text-muted text-decoration-none">Privacy policy</a>
    <span class="mx-2">·</span>
    <a href="#" class="text-muted text-decoration-none">Terms and conditions</a>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.data('invioApp', () => ({
        draft: null,
        activeTab: 'invoice',
        modalOpen: null,
        errors: {},
        summaryError: '',
        totals: null,
        unitCodeOptions: [
          { value: 'C62', label: 'pcs' }, { value: 'DAY', label: 'days' }, { value: 'HUR', label: 'hours' },
          { value: 'KGM', label: 'kg' }, { value: 'LTR', label: 'l' }, { value: 'MTR', label: 'm' }, { value: 'PCE', label: 'piece' }
        ],
        countryOptions: [
          { value: 'LV', label: 'Latvia' }, { value: 'EE', label: 'Estonia' }, { value: 'LT', label: 'Lithuania' },
          { value: 'DE', label: 'Germany' }, { value: 'PL', label: 'Poland' }, { value: 'GB', label: 'United Kingdom' },
          { value: 'FR', label: 'France' }, { value: 'IT', label: 'Italy' }, { value: 'ES', label: 'Spain' },
          { value: 'NL', label: 'Netherlands' }, { value: 'SE', label: 'Sweden' }, { value: 'FI', label: 'Finland' }
        ],

        init() {
          const State = window.InvioState;
          const Storage = window.InvioStorage;
          if (!State) return;
          this.draft = State.createDefaultDraft();
          if (Storage && Storage.loadDraft) {
            Storage.loadDraft()
              .then(saved => {
                if (saved && saved.header) this.draft = State.normalizeDraft(saved);
                this.refreshTotals();
              })
              .catch(() => { this.summaryError = 'Could not load saved draft.'; });
          } else {
            this.refreshTotals();
          }
        },

        lineNet(line) {
          const Calc = window.InvioCalc;
          const cc = this.draft?.header?.currencyCode || 'EUR';
          return Calc ? Calc.lineNet(line, cc) : 0;
        },

        addLine() {
          const State = window.InvioState;
          if (State) this.draft = State.addLine(this.draft);
        },
        removeLine(i) {
          const State = window.InvioState;
          if (State) this.draft = State.removeLine(this.draft, i);
        },

        refreshTotals() {
          const Calc = window.InvioCalc;
          this.summaryError = '';
          if (Calc && this.draft) {
            this.totals = Calc.computeTotals(this.draft);
            const recon = Calc.checkReconciliation(this.draft);
            if (!recon.ok) this.summaryError = 'Calculations mismatch! Review your data.';
          }
        },

        mapValidationErrors(errors) {
          this.errors = { header: {}, lines: {}, seller: {}, buyer: {}, payment: {} };
          if (!errors?.length) return;
          errors.forEach(msg => {
            if (msg.includes('Invoice number')) this.errors.header.invoiceNumber = msg;
            else if (msg.includes('Invoice date')) this.errors.header.issueDate = msg;
            else if (msg.includes('Due date')) this.errors.header.dueDate = msg;
            else if (msg.includes('Seller name')) this.errors.seller = { ...this.errors.seller, name: msg };
            else if (msg.includes('Seller email')) this.errors.seller = { ...this.errors.seller, email: msg };
            else if (msg.includes('Seller country')) this.errors.seller = { ...this.errors.seller, country: msg };
            else if (msg.includes('Buyer name')) this.errors.buyer = { ...this.errors.buyer, name: msg };
            else if (msg.includes('Buyer email')) this.errors.buyer = { ...this.errors.buyer, email: msg };
            else if (msg.includes('Buyer country')) this.errors.buyer = { ...this.errors.buyer, country: msg };
            else if (msg.includes('IBAN')) this.errors.payment = { ...this.errors.payment, iban: msg };
            else if (msg.startsWith('Line ')) {
              const i = parseInt(msg.replace(/Line (\d+):.*/, '$1'), 10) - 1;
              if (!isNaN(i)) this.errors.lines[i] = msg.replace(/^Line \d+: /, '');
            }
          });
        },

        exportAll() {
          this.refreshTotals();
          this.summaryError = '';
          this.errors = {};
          const Validation = window.InvioValidation;
          const XML = window.InvioXML;
          const PDF = window.InvioPDF;
          if (!Validation || !XML || !PDF) return;
          try {
            const result = Validation.validateForExport(this.draft);
            if (!result.valid) {
              this.mapValidationErrors(result.errors);
              this.summaryError = result.errors?.[0] || 'Validation failed';
              return;
            }
            const xmlResult = XML.generateAndDownloadXML(this.draft);
            if (!xmlResult.ok) {
              this.summaryError = xmlResult.errors?.[0] || 'XML export failed';
              return;
            }
            PDF.generateAndDownloadPDF(this.draft)
              .then(pdfResult => {
                if (!pdfResult.ok) this.summaryError = pdfResult.error || pdfResult.errors?.[0] || 'PDF export failed';
              })
              .catch(err => { this.summaryError = err?.message || 'PDF export failed'; });
          } catch (err) {
            this.summaryError = err?.message || 'Export failed';
          }
        }
      }));
    });
  </script>

  <script src="assets/js/state.js"></script>
  <script src="assets/js/storage.js"></script>
  <script src="assets/js/calc.js"></script>
  <script src="assets/js/validation.js"></script>
  <script src="assets/js/xml.js"></script>
  <script src="assets/js/pdf.js"></script>
  <script src="assets/js/ui.js"></script>
</body>
</html>
