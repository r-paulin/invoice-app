<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invio — Invoice Generator</title>
  <link rel="stylesheet" href="assets/css/main.css">
  <script defer src="https://unpkg.com/alpinejs@3.13.3/dist/cdn.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js" crossorigin="anonymous"></script>
</head>
<body>
  <div class="invio-app" x-data="invioApp()" x-init="init()">
    <header class="invio-header">
      <div class="invio-logo">invio</div>
      <div class="invio-header-actions">
        <span class="invio-save-status" x-show="saveStatus" x-text="saveStatus"></span>
        <button type="button" class="invio-btn invio-btn-secondary" @click="save()" title="Save">Save</button>
        <button type="button" class="invio-btn invio-btn-secondary" @click="close()" title="Close">×</button>
      </div>
    </header>

    <!-- Tabs: Invoice data | Settings -->
    <nav class="invio-tabs" role="tablist">
      <button type="button" class="invio-tab" :class="{ 'invio-tab-active': activeTab === 'invoice' }" @click="activeTab = 'invoice'" role="tab">Invoice data</button>
      <button type="button" class="invio-tab" :class="{ 'invio-tab-active': activeTab === 'settings' }" @click="activeTab = 'settings'" role="tab">Settings</button>
    </nav>

    <main class="invio-main">
      <!-- Invoice data tab -->
      <div class="invio-tab-panel" x-show="activeTab === 'invoice'" role="tabpanel">
        <!-- Invoice details (empty states: placeholders) -->
        <section class="invio-section">
          <h2 class="invio-section-title">Invoice details</h2>
          <div class="invio-details-grid">
            <div class="invio-field">
              <label class="invio-label">Invoice number</label>
              <input type="text" class="invio-input" :class="{ 'invio-invalid': errors.header?.invoiceNumber }" x-model="draft.header.invoiceNumber" placeholder="e.g. INV-001">
              <span class="invio-error-text" x-show="errors.header?.invoiceNumber" x-text="errors.header?.invoiceNumber"></span>
            </div>
            <div class="invio-field">
              <label class="invio-label">Invoice date</label>
              <input type="date" class="invio-input" :class="{ 'invio-invalid': errors.header?.issueDate }" x-model="draft.header.issueDate">
              <span class="invio-error-text" x-show="errors.header?.issueDate" x-text="errors.header?.issueDate"></span>
            </div>
            <div class="invio-field">
              <label class="invio-label">Due date</label>
              <input type="date" class="invio-input" x-model="draft.header.dueDate" placeholder="Due date">
            </div>
            <div class="invio-field">
              <label class="invio-label">Currency</label>
              <select class="invio-select" x-model="draft.header.currencyCode">
                <option value="EUR">EUR</option>
                <option value="USD">USD</option>
                <option value="GBP">GBP</option>
              </select>
            </div>
            <div class="invio-field">
              <label class="invio-label">Reference</label>
              <input type="text" class="invio-input" x-model="draft.header.buyerReference" placeholder="Optional reference">
            </div>
            <div class="invio-field">
              <label class="invio-label">Invoice type</label>
              <select class="invio-select" x-model="draft.header.typeCode">
                <option value="380">Commercial Invoice</option>
                <option value="381">Credit note</option>
              </select>
            </div>
          </div>
          <div class="invio-field invio-field-full">
            <label class="invio-label">Note</label>
            <textarea class="invio-textarea" x-model="draft.header.note" placeholder="Optional note"></textarea>
          </div>
        </section>

        <!-- Items: Notion-like table -->
        <section class="invio-section">
          <h2 class="invio-section-title">Items</h2>
          <div class="invio-table-wrap">
            <table class="invio-table">
              <thead>
                <tr>
                  <th class="invio-th invio-th-desc">Description</th>
                  <th class="invio-th invio-th-qty">Qty</th>
                  <th class="invio-th invio-th-unit">Unit</th>
                  <th class="invio-th invio-th-price">Price</th>
                  <th class="invio-th invio-th-vatcat">VAT category</th>
                  <th class="invio-th invio-th-vatpct">VAT %</th>
                  <th class="invio-th invio-th-total">Line total</th>
                  <th class="invio-th invio-th-action"></th>
                </tr>
              </thead>
              <tbody>
                <template x-for="(line, i) in draft.lines" :key="line.id">
                  <tr class="invio-tr">
                    <td class="invio-td invio-td-desc">
                      <input type="text" class="invio-table-input" :class="{ 'invio-invalid': errors.lines && errors.lines[i] }" x-model="draft.lines[i].itemName" placeholder="Item name">
                      <span class="invio-error-text invio-error-inline" x-show="errors.lines && errors.lines[i]" x-text="errors.lines[i]"></span>
                    </td>
                    <td class="invio-td invio-td-qty"><input type="number" step="any" min="0.001" class="invio-table-input invio-input-num" x-model.number="draft.lines[i].quantity"></td>
                    <td class="invio-td invio-td-unit">
                      <select class="invio-table-select" x-model="draft.lines[i].unitCode">
                        <template x-for="opt in unitCodeOptions" :key="opt.value">
                          <option :value="opt.value" x-text="opt.label"></option>
                        </template>
                      </select>
                    </td>
                    <td class="invio-td invio-td-price"><input type="number" step="0.01" min="0" class="invio-table-input invio-input-num" x-model.number="draft.lines[i].netPrice"></td>
                    <td class="invio-td invio-td-vatcat">
                      <select class="invio-table-select" x-model="draft.lines[i].vatCategoryCode">
                        <template x-for="opt in vatCategoryOptions" :key="opt.value">
                          <option :value="opt.value" x-text="opt.label"></option>
                        </template>
                      </select>
                    </td>
                    <td class="invio-td invio-td-vatpct"><input type="number" step="0.01" min="0" max="100" class="invio-table-input invio-input-num" x-model.number="draft.lines[i].vatRate"></td>
                    <td class="invio-td invio-td-total" x-text="(lineNet(draft.lines[i]) || 0).toFixed(2) + ' ' + (draft.header.currencyCode || 'EUR')"></td>
                    <td class="invio-td invio-td-action">
                      <button type="button" class="invio-btn-icon" title="Remove line" x-show="draft.lines.length > 1" @click="removeLine(i)">×</button>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
          <p class="invio-empty-hint" x-show="!draft.lines.length || draft.lines.every(l => !l.itemName && !l.netPrice)">No items yet. Add a row below.</p>
          <button type="button" class="invio-btn invio-btn-secondary invio-btn-add-row" @click="addLine()">+ Add row</button>
        </section>

        <!-- Totals (filled state) -->
        <section class="invio-section invio-totals-section">
          <h2 class="invio-section-title">Totals</h2>
          <div class="invio-summary">
            <div class="invio-summary-row"><span>Invoice lines subtotal</span><span x-text="(totals && totals.lineNetSum != null ? totals.lineNetSum.toFixed(2) : '—') + ' ' + (draft.header.currencyCode || 'EUR')"></span></div>
            <div class="invio-summary-row"><span>Document discount</span><span x-text="'-' + (totals && totals.allowanceSum != null ? totals.allowanceSum.toFixed(2) : '0.00') + ' ' + (draft.header.currencyCode || 'EUR')"></span></div>
            <div class="invio-summary-row"><span>Total net amount</span><span x-text="(totals && totals.taxExclusive != null ? totals.taxExclusive.toFixed(2) : '—') + ' ' + (draft.header.currencyCode || 'EUR')"></span></div>
            <template x-for="vb in (totals && totals.vatBreakdown) || []" :key="vb.categoryCode + vb.rate">
              <div class="invio-summary-row"><span x-text="'VAT (' + vb.rate + '%)'"></span><span x-text="vb.taxAmount.toFixed(2) + ' ' + (draft.header.currencyCode || 'EUR')"></span></div>
            </template>
            <div class="invio-summary-row invio-total"><span>Total amount</span><span x-text="(totals && totals.taxInclusive != null ? totals.taxInclusive.toFixed(2) : '—') + ' ' + (draft.header.currencyCode || 'EUR')"></span></div>
            <div class="invio-summary-row invio-total"><span>Amount payable</span><span x-text="(totals && totals.payable != null ? totals.payable.toFixed(2) : '—') + ' ' + (draft.header.currencyCode || 'EUR')"></span></div>
          </div>
          <p class="invio-summary-error" x-show="summaryError" x-text="summaryError"></p>
          <button type="button" class="invio-btn invio-btn-primary invio-btn-export" @click="exportAll()">Generate XML &amp; PDF</button>
        </section>
      </div>

      <!-- Settings tab: Seller, Buyer, Payment (open modals) -->
      <div class="invio-tab-panel" x-show="activeTab === 'settings'" role="tabpanel">
        <section class="invio-section">
          <h2 class="invio-section-title">Settings</h2>
          <div class="invio-settings-cards">
            <button type="button" class="invio-settings-card" @click="modalOpen = 'seller'">
              <span class="invio-settings-card-title">Seller</span>
              <span class="invio-settings-card-preview" x-text="draft.seller.name || 'Add seller details'"></span>
            </button>
            <button type="button" class="invio-settings-card" @click="modalOpen = 'buyer'">
              <span class="invio-settings-card-title">Buyer</span>
              <span class="invio-settings-card-preview" x-text="draft.buyer.name || 'Add buyer details'"></span>
            </button>
            <button type="button" class="invio-settings-card" @click="modalOpen = 'payment'">
              <span class="invio-settings-card-title">Payment</span>
              <span class="invio-settings-card-preview" x-text="draft.payment.accountId || draft.payment.bankName || 'Add payment details'"></span>
            </button>
          </div>
        </section>
      </div>
    </main>

    <!-- Modal: Seller -->
    <div class="invio-modal-overlay" x-show="modalOpen === 'seller'" x-transition @click.self="modalOpen = null">
      <div class="invio-modal" @click.stop role="dialog" aria-labelledby="modal-seller-title">
        <div class="invio-modal-header">
          <h3 id="modal-seller-title" class="invio-modal-title">Seller</h3>
          <button type="button" class="invio-btn-icon invio-modal-close" @click="modalOpen = null" aria-label="Close">×</button>
        </div>
        <div class="invio-modal-body">
          <div class="invio-field"><label class="invio-label">Name</label><input type="text" class="invio-input" x-model="draft.seller.name" placeholder="Company or person name"></div>
          <div class="invio-field"><label class="invio-label">Legal / Trade name</label><input type="text" class="invio-input" x-model="draft.seller.tradeName" placeholder="Optional"></div>
          <div class="invio-field"><label class="invio-label">Registration number</label><input type="text" class="invio-input" x-model="draft.seller.legalRegistrationId" placeholder="Optional"></div>
          <div class="invio-field"><label class="invio-label">VAT number</label><input type="text" class="invio-input" x-model="draft.seller.vatId" placeholder="Optional"></div>
          <div class="invio-field"><label class="invio-label">E-mail</label><input type="email" class="invio-input" :class="{ 'invio-invalid': errors.seller?.email }" x-model="draft.seller.contact.email" placeholder="email@example.com"><span class="invio-error-text" x-show="errors.seller?.email" x-text="errors.seller?.email"></span></div>
          <div class="invio-field"><label class="invio-label">Phone</label><input type="text" class="invio-input" x-model="draft.seller.contact.phone" placeholder="Optional"></div>
          <div class="invio-field"><label class="invio-label">Address</label><input type="text" class="invio-input" x-model="draft.seller.address.line1" placeholder="Street and number"></div>
          <div class="invio-field"><label class="invio-label">City</label><input type="text" class="invio-input" x-model="draft.seller.address.city" placeholder="City"></div>
          <div class="invio-field"><label class="invio-label">Postal code</label><input type="text" class="invio-input" x-model="draft.seller.address.postalCode" placeholder="Postal code"></div>
          <div class="invio-field"><label class="invio-label">Country</label>
            <select class="invio-select" x-model="draft.seller.address.countryCode">
              <option value="">—</option>
              <template x-for="opt in countryOptions" :key="opt.value">
                <option :value="opt.value" x-text="opt.label"></option>
              </template>
            </select>
          </div>
        </div>
        <div class="invio-modal-footer">
          <button type="button" class="invio-btn invio-btn-primary" @click="modalOpen = null">Done</button>
        </div>
      </div>
    </div>

    <!-- Modal: Buyer -->
    <div class="invio-modal-overlay" x-show="modalOpen === 'buyer'" x-transition @click.self="modalOpen = null">
      <div class="invio-modal" @click.stop role="dialog" aria-labelledby="modal-buyer-title">
        <div class="invio-modal-header">
          <h3 id="modal-buyer-title" class="invio-modal-title">Buyer</h3>
          <button type="button" class="invio-btn-icon invio-modal-close" @click="modalOpen = null" aria-label="Close">×</button>
        </div>
        <div class="invio-modal-body">
          <div class="invio-field"><label class="invio-label">Name</label><input type="text" class="invio-input" x-model="draft.buyer.name" placeholder="Company or person name"></div>
          <div class="invio-field"><label class="invio-label">Legal / Trade name</label><input type="text" class="invio-input" x-model="draft.buyer.tradeName" placeholder="Optional"></div>
          <div class="invio-field"><label class="invio-label">Registration number</label><input type="text" class="invio-input" x-model="draft.buyer.legalRegistrationId" placeholder="Optional"></div>
          <div class="invio-field"><label class="invio-label">VAT number</label><input type="text" class="invio-input" x-model="draft.buyer.vatId" placeholder="Optional"></div>
          <div class="invio-field"><label class="invio-label">E-mail</label><input type="email" class="invio-input" :class="{ 'invio-invalid': errors.buyer?.email }" x-model="draft.buyer.contact.email" placeholder="email@example.com"><span class="invio-error-text" x-show="errors.buyer?.email" x-text="errors.buyer?.email"></span></div>
          <div class="invio-field"><label class="invio-label">Phone</label><input type="text" class="invio-input" x-model="draft.buyer.contact.phone" placeholder="Optional"></div>
          <div class="invio-field"><label class="invio-label">Address</label><input type="text" class="invio-input" x-model="draft.buyer.address.line1" placeholder="Street and number"></div>
          <div class="invio-field"><label class="invio-label">City</label><input type="text" class="invio-input" x-model="draft.buyer.address.city" placeholder="City"></div>
          <div class="invio-field"><label class="invio-label">Postal code</label><input type="text" class="invio-input" x-model="draft.buyer.address.postalCode" placeholder="Postal code"></div>
          <div class="invio-field"><label class="invio-label">Country</label>
            <select class="invio-select" x-model="draft.buyer.address.countryCode">
              <option value="">—</option>
              <template x-for="opt in countryOptions" :key="opt.value">
                <option :value="opt.value" x-text="opt.label"></option>
              </template>
            </select>
          </div>
        </div>
        <div class="invio-modal-footer">
          <button type="button" class="invio-btn invio-btn-primary" @click="modalOpen = null">Done</button>
        </div>
      </div>
    </div>

    <!-- Modal: Payment -->
    <div class="invio-modal-overlay" x-show="modalOpen === 'payment'" x-transition @click.self="modalOpen = null">
      <div class="invio-modal" @click.stop role="dialog" aria-labelledby="modal-payment-title">
        <div class="invio-modal-header">
          <h3 id="modal-payment-title" class="invio-modal-title">Payment</h3>
          <button type="button" class="invio-btn-icon invio-modal-close" @click="modalOpen = null" aria-label="Close">×</button>
        </div>
        <div class="invio-modal-body">
          <div class="invio-field"><label class="invio-label">Payment type</label>
            <select class="invio-select" x-model="draft.payment.meansTypeCode">
              <option value="30">Credit Transfer</option>
              <option value="48">Bank transfer</option>
            </select>
          </div>
          <div class="invio-field"><label class="invio-label">Bank name</label><input type="text" class="invio-input" x-model="draft.payment.bankName" placeholder="Bank name (related to IBAN)"></div>
          <div class="invio-field"><label class="invio-label">SWIFT/BIC</label><input type="text" class="invio-input" x-model="draft.payment.bic" placeholder="Optional"></div>
          <div class="invio-field"><label class="invio-label">IBAN</label><input type="text" class="invio-input" :class="{ 'invio-invalid': errors.payment?.iban }" x-model="draft.payment.accountId" placeholder="e.g. LV80BANK0000435195001"><span class="invio-error-text" x-show="errors.payment?.iban" x-text="errors.payment?.iban"></span></div>
          <div class="invio-field"><label class="invio-label">Additional payment notes</label><textarea class="invio-textarea" x-model="draft.payment.notes" placeholder="Optional"></textarea></div>
        </div>
        <div class="invio-modal-footer">
          <button type="button" class="invio-btn invio-btn-primary" @click="modalOpen = null">Done</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.data('invioApp', () => ({
        draft: null,
        activeTab: 'invoice',
        modalOpen: null,
        errors: {},
        summaryError: '',
        saveStatus: '',
        totals: null,
        unitCodeOptions: [
          { value: 'C62', label: 'pcs' }, { value: 'DAY', label: 'days' }, { value: 'HUR', label: 'hours' },
          { value: 'KGM', label: 'kg' }, { value: 'LTR', label: 'l' }, { value: 'MTR', label: 'm' }, { value: 'PCE', label: 'piece' }
        ],
        vatCategoryOptions: [
          { value: 'S', label: 'Standard rate' }, { value: 'Z', label: 'Zero rate' }, { value: 'E', label: 'Exempt' },
          { value: 'G', label: 'Free export' }, { value: 'O', label: 'Not subject to VAT' }
        ],
        countryOptions: [
          { value: 'LV', label: 'Latvia' }, { value: 'EE', label: 'Estonia' }, { value: 'LT', label: 'Lithuania' },
          { value: 'DE', label: 'Germany' }, { value: 'PL', label: 'Poland' }, { value: 'GB', label: 'United Kingdom' },
          { value: 'FR', label: 'France' }, { value: 'IT', label: 'Italy' }, { value: 'ES', label: 'Spain' },
          { value: 'NL', label: 'Netherlands' }, { value: 'SE', label: 'Sweden' }, { value: 'FI', label: 'Finland' }
        ],

        init() {
          const State = window.InvioState;
          const Storage = window.InvioStorage;
          if (!State) return;
          this.draft = State.createDefaultDraft();
          if (Storage && Storage.loadDraft) {
            Storage.loadDraft()
              .then(saved => {
                if (saved && saved.header) this.draft = State.normalizeDraft(saved);
                this.refreshTotals();
              })
              .catch(() => { this.summaryError = 'Could not load saved draft.'; });
          } else {
            this.refreshTotals();
          }
        },

        lineNet(line) {
          const Calc = window.InvioCalc;
          const cc = this.draft && this.draft.header && this.draft.header.currencyCode || 'EUR';
          return Calc ? Calc.lineNet(line, cc) : 0;
        },

        addLine() {
          const State = window.InvioState;
          if (State) this.draft = State.addLine(this.draft);
        },
        removeLine(i) {
          const State = window.InvioState;
          if (State) this.draft = State.removeLine(this.draft, i);
        },

        refreshTotals() {
          const Calc = window.InvioCalc;
          this.summaryError = '';
          if (Calc && this.draft) {
            this.totals = Calc.computeTotals(this.draft);
            const recon = Calc.checkReconciliation(this.draft);
            if (!recon.ok) this.summaryError = 'Calculations mismatch! Review your data.';
          }
        },

        async save() {
          const Storage = window.InvioStorage;
          this.saveStatus = '';
          if (!Storage || !Storage.saveDraft) return;
          try {
            const result = await Storage.saveDraft(this.draft);
            this.saveStatus = result.ok ? 'Saved' : (result.error || 'Save failed');
            if (this.saveStatus === 'Saved') setTimeout(() => { this.saveStatus = ''; }, 2000);
          } catch (_) {
            this.saveStatus = 'Save failed';
          }
        },
        close() { window.close(); },

        mapValidationErrors(errors) {
          this.errors = { header: {}, lines: {}, seller: {}, buyer: {}, payment: {} };
          if (!errors || !errors.length) return;
          errors.forEach(msg => {
            if (msg.includes('Invoice number')) this.errors.header.invoiceNumber = msg;
            else if (msg.includes('Invoice date')) this.errors.header.issueDate = msg;
            else if (msg.includes('Due date')) this.errors.header.dueDate = msg;
            else if (msg.includes('Seller name')) this.errors.seller = { ...this.errors.seller, name: msg };
            else if (msg.includes('Seller email')) this.errors.seller = { ...this.errors.seller, email: msg };
            else if (msg.includes('Seller country')) this.errors.seller = { ...this.errors.seller, country: msg };
            else if (msg.includes('Buyer name')) this.errors.buyer = { ...this.errors.buyer, name: msg };
            else if (msg.includes('Buyer email')) this.errors.buyer = { ...this.errors.buyer, email: msg };
            else if (msg.includes('Buyer country')) this.errors.buyer = { ...this.errors.buyer, country: msg };
            else if (msg.includes('IBAN')) this.errors.payment = { ...this.errors.payment, iban: msg };
            else if (msg.startsWith('Line ')) {
              const i = parseInt(msg.replace(/Line (\d+):.*/, '$1'), 10) - 1;
              if (!isNaN(i)) this.errors.lines[i] = msg.replace(/^Line \d+: /, '');
            }
          });
        },
        exportAll() {
          this.refreshTotals();
          this.summaryError = '';
          this.errors = {};
          const Validation = window.InvioValidation;
          const XML = window.InvioXML;
          const PDF = window.InvioPDF;
          if (!Validation || !XML || !PDF) return;
          try {
            const result = Validation.validateForExport(this.draft);
            if (!result.valid) {
              this.mapValidationErrors(result.errors);
              this.summaryError = result.errors && result.errors[0] || 'Validation failed';
              return;
            }
            const xmlResult = XML.generateAndDownloadXML(this.draft);
            if (!xmlResult.ok) {
              this.summaryError = xmlResult.errors && xmlResult.errors[0] || 'XML export failed';
              return;
            }
            PDF.generateAndDownloadPDF(this.draft)
              .then(pdfResult => {
                if (!pdfResult.ok) this.summaryError = pdfResult.error || (pdfResult.errors && pdfResult.errors[0]) || 'PDF export failed';
              })
              .catch(err => { this.summaryError = (err && err.message) || 'PDF export failed'; });
          } catch (err) {
            this.summaryError = (err && err.message) || 'Export failed';
          }
        }
      }));
    });
  </script>

  <script src="assets/js/state.js"></script>
  <script src="assets/js/storage.js"></script>
  <script src="assets/js/calc.js"></script>
  <script src="assets/js/validation.js"></script>
  <script src="assets/js/xml.js"></script>
  <script src="assets/js/pdf.js"></script>
  <script src="assets/js/ui.js"></script>
</body>
</html>
